<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Support</title>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html, body {
            height: 100%; /* Ensure body takes full height */
        }
        body {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            padding: 10px; /* Padding for spacing on larger screens */
            overflow: hidden; /* Prevent body scroll */
        }

        /* Chat Container */
        .chat-container {
            width: 90%;
            max-width: 500px;
            height: 90vh; /* Increased height */
            max-height: 750px; /* Increased max-height */
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden; /* Prevent container scroll, internal elements will scroll */
        }

        /* Chat Header */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9em;
            flex-shrink: 0; /* Prevent header shrinking */
        }
        #admin-status .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
            vertical-align: middle;
            background-color: #ccc; /* Default offline */
            transition: background-color 0.3s ease;
        }
        #admin-status .status-dot.online { background-color: #33ff33; }
        #admin-status .status-dot.offline { background-color: #ccc; }

        /* Messages Area */
        .messages {
            flex: 1; /* Take available space */
            overflow-y: auto; /* Allow vertical scrolling */
            margin-bottom: 15px;
            padding-right: 5px; /* Space for scrollbar */
            display: flex;
            flex-direction: column;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(255,255,255,0.3) transparent; /* Firefox */
        }
        .messages::-webkit-scrollbar { width: 6px; }
        .messages::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 3px; }
        .messages::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }

        /* Message Styling */
        .message-wrapper {
             display: flex;
             margin-bottom: 12px; /* Slightly more spacing */
             max-width: 85%;
             position: relative; /* For potential absolute elements later if needed */
        }
        .message-wrapper.sent { align-self: flex-end; justify-content: flex-end; }
        .message-wrapper.received { align-self: flex-start; } /* Admin messages */
        .message-wrapper.bot { align-self: flex-start; } /* System messages */

        .message-wrapper p {
            padding: 10px 15px;
            border-radius: 18px; /* Slightly more rounded */
            word-wrap: break-word;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            line-height: 1.45; /* Improved line height */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .message-wrapper.sent p {
            background-color: #00c6ff;
            color: #111; /* Darker text for better contrast */
            border-bottom-right-radius: 5px;
        }
        .message-wrapper.received p {
            background-color: #ffd700;
            color: #111; /* Darker text */
            border-bottom-left-radius: 5px;
        }
        .message-wrapper.bot p {
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            border-bottom-left-radius: 5px;
        }

        /* Timestamp Styling */
        .timestamp { /* Changed from .message-wrapper .timestamp */
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.65); /* Slightly brighter */
            margin-top: 4px;
            padding: 0 5px; /* Add padding to prevent sticking to edge */
            display: block;
        }
        .message-wrapper.sent .timestamp { text-align: right; }
        .message-wrapper.received .timestamp, .message-wrapper.bot .timestamp { text-align: left; }

        /* Typing Indicator */
        #typing-indicator {
            min-height: 18px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85em;
            margin-bottom: 5px;
            padding-left: 5px;
            transition: opacity 0.3s ease;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Input Area */
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: auto; /* Push to bottom if content is short (unlikely) */
            padding-top: 10px; /* Space above input */
            flex-shrink: 0; /* Prevent shrinking */
        }
        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            outline: none;
            font-size: 1em; /* Ensure readable font size */
        }
        input[type="text"]::placeholder { color: #888; }
        input[type="text"]:disabled { background-color: #ddd; cursor: not-allowed; }

        /* Buttons */
        button {
            padding: 12px 18px;
            border: none;
            border-radius: 10px;
            background-color: #00ffcc;
            color: #000;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
            font-size: 0.95em; /* Slightly larger font */
        }
        button:hover:not(:disabled) { background-color: #00ccaa; }
        button:disabled { background-color: #aaa; cursor: not-allowed; color: #eee; }

        /* Audio Call Button */
        .audio-call {
            margin-top: 10px;
            background-color: #ff4f81;
            color: white;
            width: 100%;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .audio-call:hover:not(:disabled) { background-color: #f03a6a; }

        /* Call Status */
        #call-status {
             margin-top: 8px;
             text-align: center;
             font-weight: bold;
             min-height: 20px;
             font-size: 0.9em;
             flex-shrink: 0; /* Prevent shrinking */
        }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            body { padding: 0; } /* Remove padding on mobile */
            .chat-container {
                width: 100%;
                height: 100vh; /* Full screen height */
                max-height: 100vh; /* Full screen max height */
                border-radius: 0; /* No rounded corners */
                padding: 15px; /* Adjust padding */
            }
            .chat-header { font-size: 0.8em; padding-bottom: 8px; margin-bottom: 10px;}
            .message-wrapper { max-width: 90%; }
            input[type="text"] { padding: 10px 12px; font-size: 0.95em; }
            button { padding: 10px 15px; font-size: 0.9em; }
            .audio-call { padding: 10px; }
        }
    </style>
</head>
<body>

    <!-- Main Chat UI -->
    <div class="chat-container">
        <div class="chat-header">
             <span>Chat with Support</span>
             <div id="admin-status">Admin: <span class="status-dot offline" title="Offline"></span></div>
        </div>
        <div class="messages" id="messages">
             <!-- Messages appear here -->
        </div>
        <div id="typing-indicator"></div>
        <div class="input-container">
            <!-- Input starts disabled, enabled after init -->
            <input type="text" id="messageInput" placeholder="Loading chat..." autocomplete="off" disabled/>
            <!-- Send button starts disabled -->
            <button id="sendButton" disabled>Send</button>
        </div>
        <!-- Call button starts disabled -->
        <button class="audio-call" id="audioCallButton" disabled>Start Audio Call</button>
        <div id="call-status"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, onChildAdded, serverTimestamp, onDisconnect, query, orderByChild, limitToLast, off, update } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA5mBW5mXff46acu01BbPmZh8LGGXV42v8",
            authDomain: "chat-app-ddecb.firebaseapp.com",
            databaseURL: "https://chat-app-ddecb-default-rtdb.firebaseio.com",
            projectId: "chat-app-ddecb",
            storageBucket: "chat-app-ddecb.firebasestorage.app",
            messagingSenderId: "534760202357",
            appId: "1:534760202357:web:da7d90561af1c4220a183c",
            measurementId: "G-MCSSLKG71W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const adminStatusSpan = document.getElementById('admin-status').querySelector('.status-dot');
        const typingIndicatorDiv = document.getElementById('typing-indicator');
        const callButton = document.getElementById('audioCallButton');
        const callStatusDiv = document.getElementById('call-status');

        // --- State Variables ---
        let userId = localStorage.getItem('chatUserId');
        let userName = localStorage.getItem('chatUserName');
        let chatState = 'INITIALIZING'; // INITIALIZING, AWAITING_NAME, CHATTING
        let chatRef = null;
        let messagesRef = null;
        let userStatusRef = null;
        let userTypingRef = null;
        let adminTypingRef = null;
        let callRef = null;
        let metadataRef = null; // Reference to user metadata
        let adminOnlineRef = ref(db, 'adminStatus/online');
        let typingTimeout = null;
        let messageListener = null;
        let adminStatusListener = null;
        let adminTypingListener = null;
        let callListener = null;

        // --- Initialization ---
        function initApp() {
            console.log("Initializing App...");
            // Ensure userId exists or create one
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('chatUserId', userId);
                console.log("Generated new userId:", userId);
            } else {
                console.log("Using existing userId:", userId);
            }

            // Define Firebase paths early
            chatRef = ref(db, `chats/${userId}`);
            messagesRef = ref(db, `chats/${userId}/messages`);
            userStatusRef = ref(db, `chats/${userId}/status`);
            callRef = ref(db, `chats/${userId}/call`);
            userTypingRef = ref(db, `chats/${userId}/status/userTyping`);
            adminTypingRef = ref(db, `chats/${userId}/status/adminTyping`);
            metadataRef = ref(db, `chats/${userId}/metadata`); // Metadata ref

            // Add core event listeners
            sendButton.onclick = handleSendAction;
            messageInput.onkeydown = handleInputKeyDown;
            callButton.onclick = startCall;

            // Check if user name already exists
            if (userName) {
                console.log(`Username '${userName}' found in localStorage.`);
                chatState = 'CHATTING';
                enableChattingUI(); // Enable UI elements for chatting
                startChatSession(); // Connect to Firebase
            } else {
                console.log("Username not found. Awaiting name input.");
                chatState = 'AWAITING_NAME';
                // Enable input/send specifically for name entry
                messageInput.disabled = false;
                sendButton.disabled = false;
                callButton.disabled = true; // Keep call disabled
                promptForName();
            }

            requestNotificationPermission();
            listenToAdminStatus(); // Start listening for admin status regardless of user name state
        }

        // --- Name Handling ---
        function promptForName() {
            displayMessage('bot', 'Welcome! Please enter your name to start chatting.');
            messageInput.placeholder = "Enter your name here...";
            messageInput.focus();
        }

        function handleNameSubmission() {
            const name = messageInput.value.trim();
            if (!name) {
                displayMessage('bot', 'Name cannot be empty. Please tell me your name.');
                messageInput.placeholder = "Enter your name again..."; // Update placeholder
                return; // Don't proceed if name is empty
            }

            userName = name;
            localStorage.setItem('chatUserName', userName);
            chatState = 'CHATTING';
            console.log(`Username set to: ${userName}`);

            // Display the name entered as if sent by the user
            displayMessage('sent', name); // Show user's name input

            // Confirmation message
            displayMessage('bot', `Thanks, ${userName}! You can now send messages or start a call.`);

            // Clear input and update placeholder for chatting
            messageInput.value = '';
            messageInput.placeholder = "Type your message...";

            // ** Crucial: Store metadata in Firebase AFTER getting the name **
            set(metadataRef, {
                userName: userName,
                userId: userId,
                firstSeen: serverTimestamp(),
                lastActive: serverTimestamp() // Set initial last active time
            }).then(() => {
                console.log("User metadata saved to Firebase.");
                // Now fully enable chat and connect to Firebase session
                enableChattingUI();
                startChatSession();
            }).catch(error => {
                console.error("Error setting user metadata:", error);
                // Handle error appropriately - maybe inform user?
                displayMessage('bot', "Sorry, there was an error saving your name. Please try refreshing.");
                // Disable input again if saving failed?
                messageInput.disabled = true;
                sendButton.disabled = true;
            });
        }

        // --- UI State Management ---
        function enableChattingUI() {
            console.log("Enabling full chat UI.");
            messageInput.disabled = false;
            sendButton.disabled = false;
            callButton.disabled = false; // Enable call button
            messageInput.placeholder = "Type your message...";
        }

        // --- Firebase Session ---
        function startChatSession() {
            if (!userId || !userName) {
                console.error("Cannot start chat session without userId and userName.");
                return;
            }
            console.log("Starting Firebase listeners...");

            // Detach previous listeners (safety measure)
            if (messageListener) off(messagesRef, 'child_added', messageListener);
            // if (adminStatusListener) off(adminOnlineRef, 'value', adminStatusListener); // Keep this running
            if (adminTypingListener) off(adminTypingRef, 'value', adminTypingListener);
            if (callListener) off(callRef, 'value', callListener);

            // Listen for user online/offline status (Firebase Presence)
            const userOnlineRef = ref(db, `chats/${userId}/status/userOnline`);
            const connectedRef = ref(db, '.info/connected');

            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    console.log("Firebase connection established.");
                    set(userOnlineRef, true); // Set user as online in their chat node
                    update(metadataRef, { lastActive: serverTimestamp() }); // Update last active time
                    // Set offline and update last active time on disconnect
                    onDisconnect(userOnlineRef).set(false);
                    onDisconnect(metadataRef).update({ lastActive: serverTimestamp() });
                } else {
                    console.log("Firebase connection lost.");
                    // Typing indicator might need reset here if desired
                    // set(userTypingRef, false); // Optional: Clear typing on disconnect
                }
            });

            // Listen for incoming messages (Load history + new)
            const messagesQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(100));
            let initialLoadComplete = false;
            messageListener = onChildAdded(messagesQuery, (snapshot) => {
                 const msgId = snapshot.key;
                 const msg = snapshot.val();

                 // Prevent displaying the name submission message again if it came from Firebase quickly
                 const existingMsgEl = messagesDiv.querySelector(`.message-wrapper[data-msg-id="${msgId}"]`);
                 if (existingMsgEl) {
                     // console.log("Skipping duplicate message render:", msgId);
                     return;
                 }

                 if (msg) {
                    displayMessage(msg.sender === 'user' ? 'sent' : (msg.sender === 'admin' ? 'received' : 'bot'), msg.text, msg.timestamp, msgId);
                    // Send notification for admin messages when tab is hidden
                    if (msg.sender === 'admin' && document.hidden) {
                        showNotification(`New message from Admin`);
                    }
                 }
                 // Scroll after messages are added
                 if (initialLoadComplete) {
                     scrollToBottom();
                 }
            }, (error) => console.error("Error listening to messages:", error));

            // Ensure initial scroll happens after first batch of messages if any history exists
            onValue(messagesQuery, () => {
                if (!initialLoadComplete) {
                    scrollToBottom();
                    initialLoadComplete = true;
                }
            }, { onlyOnce: true });


            // Listen for Admin Typing Status
            adminTypingListener = onValue(adminTypingRef, (snapshot) => {
                typingIndicatorDiv.textContent = snapshot.val() ? 'Admin is typing...' : '';
            }, (error) => console.error("Error listening to admin typing status:", error));

            // Listen for Call Status Changes
            callListener = onValue(callRef, (snapshot) => {
                const callState = snapshot.val();
                updateCallUI(callState);
            }, (error) => console.error("Error listening to call status:", error));
        }

        // --- Core Actions ---
        function handleSendAction() {
            if (chatState === 'AWAITING_NAME') {
                handleNameSubmission();
            } else if (chatState === 'CHATTING') {
                sendChatMessage();
            } else {
                console.warn("Send action triggered in unexpected state:", chatState);
            }
        }

        function handleInputKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendAction(); // Central handler for Enter key
            } else if (chatState === 'CHATTING') {
                // Only indicate typing if user has provided name and is chatting
                handleUserTyping();
            }
        }

        function sendChatMessage() {
            const msgText = messageInput.value.trim();
            if (msgText && userId && userName && chatState === 'CHATTING') {
                messageInput.value = '';
                messageInput.focus();

                const messageData = {
                    sender: 'user',
                    text: msgText,
                    timestamp: serverTimestamp(),
                    userId: userId,
                    userName: userName // Include name with message
                };

                const newMessageRef = push(messagesRef, messageData); // Get ref to new message
                // const newMessageId = newMessageRef.key; // Get the unique key

                // Optimistic UI update is handled by onChildAdded listener now
                // displayMessage('sent', msgText, Date.now(), newMessageId); // Display immediately (optional)

                newMessageRef.then(() => {
                    // Reset typing indicator after successful send
                    if (userTypingRef) set(userTypingRef, false);
                    clearTimeout(typingTimeout);
                    // Update last active time on send
                    update(metadataRef, { lastActive: serverTimestamp() });
                }).catch(error => {
                     console.error("Error sending message: ", error);
                     // Optional: Re-populate input or show error message
                     messageInput.value = msgText; // Give user message back
                     displayMessage('bot', "Error: Message failed to send. Please try again.");
                     // Optional: Remove optimistic message if it was added
                     // const failedMsgEl = document.getElementById(`msg-${newMessageId}`);
                     // if(failedMsgEl) failedMsgEl.remove();
                });
            } else if (!msgText) {
                // Ignore empty messages silently
            } else {
                console.warn("Cannot send message. State:", chatState, "User ID:", userId, "Username:", userName);
            }
        }

        // --- Display & Scroll ---
        function displayMessage(senderType, text, timestamp, msgId = null) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper', senderType); // Types: sent, received, bot
            // Add a unique data attribute to easily find the message later if needed
            if (msgId) {
                wrapper.dataset.msgId = msgId;
            }

            const p = document.createElement('p');
            p.textContent = text; // Use textContent for safety

            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            // Only show timestamp for user/admin messages, not bot messages
            if (senderType !== 'bot' && timestamp) {
                // Format timestamp nicely
                 timeSpan.textContent = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                 timeSpan.textContent = ''; // Hide timestamp for bot messages
            }

            wrapper.appendChild(p);
            // Append timestamp *outside* the bubble <p> but still within the wrapper
            messagesDiv.appendChild(wrapper);
            wrapper.appendChild(timeSpan); // Append timestamp after the bubble

            // Don't scroll immediately, let the browser render first
            // scrollToBottom(); // Moved scrolling to be called after message add/load
        }

        function scrollToBottom() {
            // Use requestAnimationFrame for smoother scrolling after render
            requestAnimationFrame(() => {
                 messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // --- Typing Indicator ---
        function handleUserTyping() {
            if (chatState !== 'CHATTING' || !userTypingRef) return; // Only when chatting
            // Set typing to true in Firebase
            set(userTypingRef, true);
            // Clear any existing timeout to reset the timer
            clearTimeout(typingTimeout);
            // Set a timeout to mark user as stopped typing after a delay
            typingTimeout = setTimeout(() => {
                set(userTypingRef, false);
            }, 2500); // 2.5 seconds timeout
        }

        // --- Admin Status Listener ---
        function listenToAdminStatus() {
             // Detach previous listener if any
             if (adminStatusListener) off(adminOnlineRef, 'value', adminStatusListener);

             adminStatusListener = onValue(adminOnlineRef, (snapshot) => {
                const isOnline = snapshot.val()?.online; // Check nested 'online' property
                adminStatusSpan.classList.toggle('online', isOnline);
                adminStatusSpan.classList.toggle('offline', !isOnline);
                adminStatusSpan.title = isOnline ? 'Online' : 'Offline';
             }, (error) => console.error("Error listening to admin status:", error));
        }


        // --- Audio Call ---
        function startCall() {
            if (chatState !== 'CHATTING' || !callRef || !userName) {
                 console.warn("Cannot start call. State:", chatState, "CallRef:", !!callRef, "Username:", userName);
                 return; // Prevent call if not ready
            }
            console.log('Attempting to start call...');
            callButton.disabled = true;
            callStatusDiv.textContent = 'Calling Admin...';

            // Use onValue with onlyOnce to check current state safely
            onValue(callRef, (snapshot) => {
                 const currentCallState = snapshot.val();
                 if (!currentCallState || currentCallState.state === 'idle' || currentCallState.state === 'ended') {
                    // Safe to initiate call
                    set(callRef, {
                        state: 'ringing',
                        initiator: 'user',
                        timestamp: serverTimestamp(),
                        userName: userName // Send username for admin notification
                    }).catch(error => {
                        console.error("Error initiating call:", error);
                        callStatusDiv.textContent = 'Call failed to start.';
                        callButton.disabled = (chatState !== 'CHATTING'); // Re-enable only if chatting
                    });
                 } else {
                     console.log("Cannot start call, another call state is active:", currentCallState.state);
                     callStatusDiv.textContent = `Cannot start call (Admin busy: ${currentCallState.state})`;
                     // Re-enable button after a delay to prevent spamming
                     setTimeout(() => {
                         callButton.disabled = (chatState !== 'CHATTING'); // Re-enable only if chatting
                         callStatusDiv.textContent = ''; // Clear status message
                     }, 2000);
                 }
            }, { onlyOnce: true });
        }

        function userEndCall() {
             if (!callRef) return;
             console.log('User ending/cancelling call...');
             update(callRef, {
                 state: 'ended',
                 endedBy: 'user',
                 endTimestamp: serverTimestamp()
             }).catch(error => console.error("Error ending call:", error));
             // UI update is handled by the callListener
        }

        function updateCallUI(callState) {
             // Ensure UI updates only happen when in CHATTING state
             if (chatState !== 'CHATTING') {
                  callStatusDiv.textContent = '';
                  callButton.textContent = 'Start Audio Call';
                  callButton.disabled = true; // Keep disabled if not chatting
                  return; // Exit if not in the correct state
             }

             // --- Call State Handling ---
             if (!callState || callState.state === 'idle' || callState.state === 'ended') {
                // Idle or Ended state
                callStatusDiv.textContent = callState?.state === 'ended'
                    ? `Call ended${callState.endedBy ? ' by ' + callState.endedBy : ''}.`
                    : ''; // Clear status if idle
                callButton.textContent = 'Start Audio Call';
                callButton.disabled = false; // Enable starting a new call
                callButton.onclick = startCall; // Ensure correct handler
                window.adminJoinedAlertShown = false; // Reset alert flag

             } else if (callState.state === 'ringing') {
                // Ringing state
                if (callState.initiator === 'user') {
                    // User initiated the call
                    callStatusDiv.textContent = 'Calling Admin...';
                    callButton.textContent = 'Cancel Call';
                    callButton.disabled = false; // Allow cancelling
                    callButton.onclick = userEndCall; // Change handler to cancel/end
                } else {
                    // Admin initiated the call (handle if needed)
                    callStatusDiv.textContent = 'Incoming call from Admin!';
                    callButton.textContent = 'Answer'; // Example: Implement answer logic if desired
                    callButton.disabled = false;
                    // callButton.onclick = answerCall; // Needs implementation
                }

             } else if (callState.state === 'active') {
                // Active call state
                callStatusDiv.textContent = 'Call in progress with Admin';
                callButton.textContent = 'End Call';
                callButton.disabled = false; // Allow ending the call
                callButton.onclick = userEndCall;

                // Show "Admin Joined" alert only once
                if (callState.joinedBy === 'admin' && !window.adminJoinedAlertShown) {
                    alert('Admin has joined the call! (This is a simulation)');
                    window.adminJoinedAlertShown = true; // Set flag to prevent repeats
                }
             } else {
                 // Unknown state? Reset to default
                 console.warn("Unknown call state:", callState);
                 callStatusDiv.textContent = '';
                 callButton.textContent = 'Start Audio Call';
                 callButton.disabled = false;
                 callButton.onclick = startCall;
                 window.adminJoinedAlertShown = false;
             }
        }

        // --- Notifications ---
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log("Browser doesn't support notifications."); return;
            }
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    console.log(`Notification permission: ${permission}`);
                });
            }
        }

        function showNotification(message) {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return; // Exit if not supported or permission denied
            }
            // Only show if the tab/window is not focused
            if (document.hidden) {
                const notification = new Notification('Chat Support', {
                    body: message,
                    // icon: '/path/to/icon.png' // Optional: Add an icon URL
                });
                // Optional: Close notification after a few seconds
                setTimeout(notification.close.bind(notification), 5000);
            }
        }

        // --- Run Application ---
        initApp();

    </script>
</body>
</html>