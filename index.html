<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Support</title>
    <style>
        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html, body { height: 100%; }

        /* --- Animated Background --- */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab, #6a11cb, #2575fc);
            background-size: 600% 600%; /* Needs to be larger than 100% */
            animation: gradientShift 25s ease infinite; /* Adjust time for speed */
            min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; padding: 10px; overflow: hidden;
        }

        /* Chat Container */
        .chat-container {
            width: 90%; max-width: 500px; height: 90vh; max-height: 750px; background-color: rgba(255, 255, 255, 0.15); /* Slightly less transparent */
            border-radius: 20px; padding: 20px 20px 30px 20px; /* T|R|B|L - Reduced bottom padding slightly */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.18); overflow: hidden;
        }

        /* Chat Header */
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); font-size: 0.9em; flex-shrink: 0; }
        #admin-status .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 5px; vertical-align: middle; background-color: #ccc; transition: background-color 0.3s ease; }
        #admin-status .status-dot.online { background-color: #33ff33; box-shadow: 0 0 5px #33ff33; } /* Added glow */
        #admin-status .status-dot.offline { background-color: #aaa; } /* Darker Grey */

        /* Messages Area */
        .messages { flex: 1; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; display: flex; flex-direction: column; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; }
        .messages::-webkit-scrollbar { width: 6px; } .messages::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 3px; } .messages::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }

        /* Message Animations */
        @keyframes messageAppearGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes messageAppearSent { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } } /* Slide from right */

        /* Message Styling */
        .message-wrapper { display: flex; margin-bottom: 12px; max-width: 85%; position: relative; animation: messageAppearGeneral 0.35s ease-out; } /* Default animation */
        .message-wrapper.sent { align-self: flex-end; justify-content: flex-end; animation-name: messageAppearSent; /* Use specific animation for sent */ }
        .message-wrapper.received { align-self: flex-start; } .message-wrapper.bot { align-self: flex-start; }
        .message-wrapper p { padding: 10px 15px; border-radius: 18px; word-wrap: break-word; background: rgba(255, 255, 255, 0.2); color: #fff; line-height: 1.45; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; z-index: 1; }
        .message-wrapper.sent p { background: linear-gradient(to bottom right, #00c6ff, #0094ff); color: #fff; border-bottom-right-radius: 5px; } /* Gradient for sent */
        .message-wrapper.received p { background: linear-gradient(to bottom right, #ffd700, #ffb000); color: #111; border-bottom-left-radius: 5px; } /* Gradient for received */
        .message-wrapper.bot p { background-color: rgba(255, 255, 255, 0.8); color: #333; border-bottom-left-radius: 5px; }
        .message-wrapper .file-link { display: inline-block; padding: 8px 12px; background-color: rgba(0,0,0,0.2); border-radius: 8px; color: #fff; text-decoration: none; transition: background-color 0.2s; }
        .message-wrapper .file-link:hover { background-color: rgba(0,0,0,0.4); }
        .message-wrapper .file-link .file-icon { margin-right: 5px; }

        /* Timestamp & Icons */
        .timestamp { font-size: 0.7em; color: rgba(255, 255, 255, 0.75); margin-top: 4px; padding: 0 5px; display: inline-block; /* Changed to inline-block */ align-self: flex-end; line-height: 1; vertical-align: bottom; } /* Align icon better */
        .message-wrapper.sent .timestamp { text-align: right; } .message-wrapper.received .timestamp, .message-wrapper.bot .timestamp { text-align: left; }

        /* Icon Swap & Seen Indicator */
        .message-wrapper.received .timestamp::before { content: 'ðŸ‘¤'; font-size: 0.8em; margin-right: 4px; opacity: 0.7; vertical-align: middle; } /* Admin icon */
        .message-wrapper.sent .timestamp::after { /* Changed to ::after */ content: 'âœ“'; /* Single checkmark for sent */ font-size: 0.9em; margin-left: 4px; /* Space after time */ opacity: 0.6; vertical-align: middle; font-weight: bold; color: #eee; /* Subtle color */ }
        .timestamp:empty::before, .timestamp:empty::after { display: none; } /* Hide icons if timestamp empty */

        /* Typing Indicator */
        #typing-indicator { min-height: 18px; font-style: italic; color: rgba(255, 255, 255, 0.7); font-size: 0.85em; margin-bottom: 10px; padding-left: 5px; transition: opacity 0.3s ease; flex-shrink: 0; }

        /* Input Area Container */
        .input-area-container { padding-top: 5px; flex-shrink: 0; margin-top: auto; /* Push to bottom */ }

        /* Selected File Name Display */
        #selectedFileName {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px; /* Space below filename */
            display: block; /* Ensure it takes its own line */
            text-align: left;
            padding-left: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 1.2em; /* Reserve space even when empty */
            line-height: 1.2em;
        }

        /* Input Row (Text + File + Send) */
        .input-row { display: flex; gap: 10px; align-items: center; }
        #messageInput { flex: 1; padding: 12px 15px; border: none; border-radius: 10px; background-color: rgba(255, 255, 255, 0.9); color: #333; outline: none; font-size: 1em; }
        #messageInput::placeholder { color: #888; } #messageInput:disabled { background-color: #ddd; cursor: not-allowed; }

        /* File Upload Button */
        #fileUploadButton { padding: 10px; background-color: rgba(255, 255, 255, 0.7); color: #333; font-size: 1.2em; line-height: 1; flex-shrink: 0; }
        #fileUploadButton:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.9); }
        #fileUploadButton:active:not(:disabled) { transform: scale(0.95); }

        /* Send Button */
        #sendButton { flex-shrink: 0; }

        /* Buttons General */
        button { padding: 12px 18px; border: none; border-radius: 10px; background-color: #00ffcc; color: #000; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 0.95em; }
        button:hover:not(:disabled) { background-color: #00ccaa; }
        button:disabled { background-color: #aaa; cursor: not-allowed; color: #eee; }
        button:active:not(:disabled) { transform: scale(0.97); }

        /* --- Upload Progress Bar --- */
        #uploadProgressContainer {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            margin-top: 8px; /* Space above progress bar */
            overflow: hidden;
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease;
        }
        #uploadProgressBar {
            height: 100%;
            width: 0%; /* Start at 0 */
            background-color: #00ffcc;
            border-radius: 4px;
            transition: width 0.2s linear; /* Animate width change */
        }
        /* Optional: Text inside or next to bar - kept simple for now */

        /* Audio Call Button */
        .audio-call { margin-top: 15px; /* Space above call button */ background-color: #ff4f81; color: white; width: 100%; flex-shrink: 0; }
        .audio-call:hover:not(:disabled) { background-color: #f03a6a; }

        /* Call Status */
        #call-status { margin-top: 10px; text-align: center; font-weight: bold; min-height: 20px; font-size: 0.9em; flex-shrink: 0; }

        /* Hidden Elements */
        #remoteAudio, #fileInput { display: none; }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            body { padding: 0; }
            .chat-container { width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; padding: 15px 15px 25px 15px; /* T|R|B|L */ }
            .chat-header { font-size: 0.8em; padding-bottom: 8px; margin-bottom: 10px;}
            .message-wrapper { max-width: 90%; }
            #messageInput { padding: 10px 12px; font-size: 0.95em; }
            button { padding: 10px 15px; font-size: 0.9em; }
            #fileUploadButton { padding: 8px; font-size: 1.1em; }
            .audio-call { padding: 10px; margin-top: 12px; }
            #call-status { margin-top: 8px; }
            #typing-indicator { margin-bottom: 8px; }
            #selectedFileName { font-size: 0.75em; } /* Adjust filename size */
            #uploadProgressContainer { margin-top: 6px; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
             <span>Chat with Support</span>
             <div id="admin-status">Admin: <span class="status-dot offline" title="Offline"></span></div>
        </div>
        <div class="messages" id="messages"></div>
        <div id="typing-indicator"></div>

        <div class="input-area-container">
             <!-- Display selected file name -->
             <div id="selectedFileName"></div>
             <!-- Progress Bar -->
             <div id="uploadProgressContainer">
                 <div id="uploadProgressBar"></div>
             </div>
            <div class="input-row">
                <input type="text" id="messageInput" placeholder="Loading chat..." autocomplete="off" disabled/>
                <button id="fileUploadButton" title="Send File" disabled>ðŸ“Ž</button>
                <button id="sendButton" disabled>Send</button>
            </div>
            <input type="file" id="fileInput" accept="image/*,audio/*,video/*,application/pdf,.doc,.docx,.txt,.zip,.rar">
            <button class="audio-call" id="audioCallButton" disabled>Start Audio Call</button>
            <div id="call-status"></div>
        </div>
    </div>
    <audio id="remoteAudio" autoplay></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, onChildAdded, serverTimestamp, onDisconnect, query, orderByChild, limitToLast, off, update, remove, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // --- Firebase Config --- (Use your actual config)
         const firebaseConfig = { /* ... Your Firebase Config ... */
            apiKey: "AIzaSyA5mBW5mXff46acu01BbPmZh8LGGXV42v8", // Example
            authDomain: "chat-app-ddecb.firebaseapp.com",
            databaseURL: "https://chat-app-ddecb-default-rtdb.firebaseio.com",
            projectId: "chat-app-ddecb",
            storageBucket: "chat-app-ddecb.appspot.com", // Make sure this is correct
            messagingSenderId: "534760202357",
            appId: "1:5347602357:web:da7d90561af1c4220a183c",
            measurementId: "G-MCSSLKG71W"
         };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const fileUploadButton = document.getElementById('fileUploadButton');
        const fileInput = document.getElementById('fileInput');
        const selectedFileNameDiv = document.getElementById('selectedFileName'); // Filename display
        const uploadProgressContainer = document.getElementById('uploadProgressContainer'); // Progress bar container
        const uploadProgressBar = document.getElementById('uploadProgressBar'); // Actual progress bar
        const adminStatusDot = document.getElementById('admin-status').querySelector('.status-dot');
        const typingIndicatorDiv = document.getElementById('typing-indicator');
        const callButton = document.getElementById('audioCallButton');
        const callStatusDiv = document.getElementById('call-status');
        const remoteAudio = document.getElementById('remoteAudio');

        // --- State Variables ---
        let userId = localStorage.getItem('chatUserId'); let userName = localStorage.getItem('chatUserName');
        let chatState = 'INITIALIZING'; let firstMessageSent = false;
        let chatRef, messagesRef, userStatusRef, userTypingRef, adminTypingRef, callRef, metadataRef;
        const adminStatusDbRef = ref(db, 'adminStatus');
        let typingTimeout = null;
        let messageListener, adminStatusListener, adminTypingListener, callStateListener, callOfferListener, callAnswerListener, callAdminIceCandidateListener;
        let selectedFile = null; // *** Holds the File object to be uploaded ***
        let currentUploadTask = null; // To potentially cancel uploads later if needed

        // --- WebRTC State ---
        let peerConnection = null; let localStream = null;
        const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let makingOffer = false;

        // --- Initialization ---
        function initApp() {
            console.log("Initializing App v3...");
            if (!userId) { userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9); localStorage.setItem('chatUserId', userId); console.log("New userId:", userId); }
            else { console.log("Existing userId:", userId); }

            // Define Firebase paths
            chatRef = ref(db, `chats/${userId}`); messagesRef = ref(db, `chats/${userId}/messages`);
            userStatusRef = ref(db, `chats/${userId}/status`); callRef = ref(db, `chats/${userId}/call`);
            userTypingRef = ref(db, `chats/${userId}/status/userTyping`); adminTypingRef = ref(db, `chats/${userId}/status/adminTyping`);
            metadataRef = ref(db, `chats/${userId}/metadata`);

            // Event listeners
            sendButton.onclick = handleSendAction; messageInput.onkeydown = handleInputKeyDown; callButton.onclick = handleCallButtonClick;
            fileUploadButton.onclick = () => fileInput.click(); fileInput.onchange = handleFileSelect;

            // Initial state
            userName = localStorage.getItem('chatUserName');
            if (userName) {
                chatState = 'CHATTING'; firstMessageSent = true; enableChattingUI(); startChatSession();
            } else {
                chatState = 'AWAITING_FIRST_MESSAGE'; messageInput.disabled = false; sendButton.disabled = false; callButton.disabled = true; fileUploadButton.disabled = true;
                messageInput.placeholder = "Type a message to start...";
                messagesDiv.innerHTML = '<div class="message-wrapper bot"><p>Welcome! Type anything to begin.</p></div>';
                scrollToBottom();
            }
            requestNotificationPermission();
            listenToAdminStatus();
        }

        // --- Name Handling ---
        function handleFirstMessage(messageText) { /* Same */ firstMessageSent=true; displayMessage('sent',messageText,Date.now(),`local-${Date.now()}`); displayMessage('bot','Thanks! Please tell me your name:'); chatState='AWAITING_NAME'; messageInput.placeholder="Enter name..."; messageInput.focus(); }
        function handleNameSubmission(name) { /* Same */ if(!name){displayMessage('bot','Please enter name.');messageInput.placeholder="Enter name again...";return;} userName=name; localStorage.setItem('chatUserName',userName); chatState='CHATTING'; console.log(`Username set: ${userName}`); displayMessage('sent',name,Date.now(),`local-${Date.now()}-name`); displayMessage('bot',`Got it, ${userName}! Chat active.`); messageInput.value=''; messageInput.placeholder="Type message..."; set(metadataRef,{userName:userName,userId:userId,firstSeen:serverTimestamp(),lastActive:serverTimestamp()}).then(()=>{console.log("Metadata saved.");enableChattingUI();startChatSession();}).catch(e=>{console.error("Metadata save error:",e);displayMessage('bot',"Error saving name.");disableChattingUI();}); }

        // --- UI State ---
        function enableChattingUI() { /* Same */ messageInput.disabled=false; sendButton.disabled=false; callButton.disabled=false; fileUploadButton.disabled=false; messageInput.placeholder="Type message..."; }
        function disableChattingUI() { /* Same */ messageInput.disabled=true; sendButton.disabled=true; callButton.disabled=true; fileUploadButton.disabled=true; }

        // --- Firebase Session ---
        function startChatSession() { /* Same core logic */ if(!userId||!userName)return; console.log("Starting FB listeners..."); cleanupFirebaseListeners(false); const userOnlineRef=ref(db,`chats/${userId}/status/userOnline`); const connectedRef=ref(db,'.info/connected'); onValue(connectedRef,(s)=>{if(s.val()===true){set(userOnlineRef,true); update(metadataRef,{lastActive:serverTimestamp()}); onDisconnect(userOnlineRef).set(false); onDisconnect(metadataRef).update({lastActive:serverTimestamp()});}}); const messagesQuery=query(messagesRef,orderByChild('timestamp'),limitToLast(100)); let initialLoadComplete=false; messageListener=onChildAdded(messagesQuery,(s)=>{ const msgId=s.key,msg=s.val(); if(messagesDiv.querySelector(`.message-wrapper[data-msg-id="${msgId}"]`))return; if(msg){displayMessage(msg.sender==='user'?'sent':(msg.sender==='admin'?'received':'bot'),msg.content||msg.text,msg.timestamp,msgId,msg.type,msg.fileName,msg.downloadURL); if(msg.sender==='admin'&&document.hidden)showNotification(`New message`);} if(initialLoadComplete)scrollToBottom();},(e)=>console.error("Msg listener error:",e)); onValue(messagesQuery,()=>{if(!initialLoadComplete){scrollToBottom();initialLoadComplete=true;}},{onlyOnce:true}); adminTypingListener=onValue(adminTypingRef,(s)=>{typingIndicatorDiv.textContent=s.val()?'Admin typing...':'';},(e)=>console.error("Admin typing listener error:",e)); listenForCallChanges(); }

        // --- Listener Cleanup ---
        function cleanupFirebaseListeners(includeAdminStatus=true) { /* Same */ console.log("Cleaning listeners..."); if(messageListener)off(messagesRef,'child_added',messageListener); if(includeAdminStatus&&adminStatusListener)off(adminStatusDbRef,'value',adminStatusListener); if(adminTypingListener)off(adminTypingRef,'value',adminTypingListener); if(callStateListener)off(ref(db,`chats/${userId}/call/state`),'value',callStateListener); if(callOfferListener)off(ref(db,`chats/${userId}/call/offer`),'value',callOfferListener); if(callAnswerListener)off(ref(db,`chats/${userId}/call/answer`),'value',callAnswerListener); if(callAdminIceCandidateListener)off(ref(db,`chats/${userId}/call/adminIceCandidates`),'child_added',callAdminIceCandidateListener); messageListener=null; if(includeAdminStatus)adminStatusListener=null; adminTypingListener=null; callStateListener=null; callOfferListener=null; callAnswerListener=null; callAdminIceCandidateListener=null; }

        // --- Core Actions (Send Button Logic) ---
        function handleSendAction() {
            const messageText = messageInput.value.trim();

            if (chatState === 'AWAITING_FIRST_MESSAGE') { if (!messageText) return; handleFirstMessage(messageText); messageInput.value = ''; }
            else if (chatState === 'AWAITING_NAME') { if (!messageText) { displayMessage('bot','Please enter name.'); return; } handleNameSubmission(messageText); }
            else if (chatState === 'CHATTING') {
                // *** Check if a file is selected ***
                if (selectedFile) {
                    uploadAndSendFile(selectedFile); // Upload the stored file
                    selectedFile = null; // Clear selection after initiating upload
                    selectedFileNameDiv.textContent = ''; // Clear filename display
                    messageInput.disabled = false; // Re-enable text input
                    fileUploadButton.disabled = false; // Re-enable file button
                } else if (messageText) {
                    sendChatMessage(messageText); // Send text message
                    messageInput.value = '';
                }
            } else { console.warn("Send unexpected state:", chatState); }
        }
        function handleInputKeyDown(e) { /* Same */ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendAction();}else if(chatState==='CHATTING'){handleUserTyping();} }
        function sendChatMessage(msgText) { /* Same text sending logic */ if(!userId||!userName||!msgText)return; messageInput.focus(); const msgData={type:'text',sender:'user',content:msgText,timestamp:serverTimestamp(),userId:userId,userName:userName}; push(messagesRef,msgData).then(()=>{if(userTypingRef)set(userTypingRef,false); clearTimeout(typingTimeout); update(metadataRef,{lastActive:serverTimestamp()});}).catch(e=>{console.error("Send text error:",e); displayMessage('bot',"Msg send failed.");}); }

        // --- File Handling & Upload ---
        function handleFileSelect(event) {
            if (chatState !== 'CHATTING') return;
            const file = event.target.files[0];
            if (!file) {
                selectedFile = null; // Clear selection if no file chosen
                selectedFileNameDiv.textContent = '';
                return;
            }

            // Basic Validation
            const maxSize = 10 * 1024 * 1024; // Example: 10MB limit
            if (file.size > maxSize) {
                displayMessage('bot', `File too large (Max: ${maxSize/1024/1024}MB).`);
                fileInput.value = ''; // Reset input
                selectedFile = null;
                selectedFileNameDiv.textContent = '';
                return;
            }

            // Store the selected file and update UI
            selectedFile = file;
            selectedFileNameDiv.textContent = `Selected: ${file.name}`;
            console.log(`File selected: ${file.name}`);
            messageInput.value = ''; // Clear text input when file selected
            messageInput.disabled = true; // Optionally disable text input
            fileInput.value = ''; // Reset input value allows selecting same file again later
        }

        function uploadAndSendFile(fileToUpload) {
            if (!fileToUpload || currentUploadTask) return; // Prevent if no file or already uploading

            sendButton.disabled = true;
            fileUploadButton.disabled = true;
            uploadProgressContainer.style.display = 'block'; // Show progress bar
            uploadProgressBar.style.width = '0%'; // Reset progress bar visually

            console.log(`Starting upload for: ${fileToUpload.name}`);
            const filePath = `chats/${userId}/files/${Date.now()}-${fileToUpload.name}`;
            const fileStorageRef = storageRef(storage, filePath);
            currentUploadTask = uploadBytesResumable(fileStorageRef, fileToUpload);

            // Upload Listener
            currentUploadTask.on('state_changed',
                (snapshot) => { // Progress
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                    console.log('Upload: ' + progress + '%');
                },
                (error) => { // Error
                    console.error("Upload failed:", error);
                    displayMessage('bot', `Upload error for ${fileToUpload.name}.`);
                    resetUploadUI();
                },
                () => { // Complete
                    getDownloadURL(currentUploadTask.snapshot.ref).then((downloadURL) => {
                        console.log('File URL:', downloadURL);
                        const fileMessageData = {
                            type: 'file', sender: 'user', fileName: fileToUpload.name,
                            fileType: fileToUpload.type, downloadURL: downloadURL,
                            timestamp: serverTimestamp(), userId: userId, userName: userName
                        };
                        push(messagesRef, fileMessageData).then(() => {
                             update(metadataRef, { lastActive: serverTimestamp() });
                        });
                        resetUploadUI();
                        scrollToBottom();
                    }).catch(error => {
                        console.error("Get URL error:", error);
                        displayMessage('bot', `Error processing ${fileToUpload.name}.`);
                        resetUploadUI();
                    });
                }
            );
        }

        function resetUploadUI() {
             // Reset UI elements after upload attempt (success or fail)
             uploadProgressContainer.style.display = 'none';
             uploadProgressBar.style.width = '0%';
             selectedFile = null;
             selectedFileNameDiv.textContent = '';
             currentUploadTask = null;
             fileInput.value = ''; // Clear the actual file input
             // Re-enable buttons only if chatting
             if (chatState === 'CHATTING') {
                 sendButton.disabled = false;
                 fileUploadButton.disabled = false;
                 messageInput.disabled = false;
             }
        }


        // --- Display & Scroll ---
        function displayMessage(senderType, content, timestamp, msgId=null, msgType='text', fileName='', downloadURL='') { /* Same as previous response, handles file links */ const wrapper=document.createElement('div'); wrapper.classList.add('message-wrapper'); requestAnimationFrame(()=>{wrapper.classList.add(senderType);}); if(msgId)wrapper.dataset.msgId=msgId; let messageContentElement; if(msgType==='file'&&downloadURL){messageContentElement=document.createElement('a'); messageContentElement.href=downloadURL; messageContentElement.textContent=`ðŸ“Ž ${fileName||'Download File'}`; messageContentElement.target="_blank"; messageContentElement.rel="noopener noreferrer"; messageContentElement.classList.add('file-link');} else {messageContentElement=document.createElement('p'); messageContentElement.textContent=content||'';} wrapper.appendChild(messageContentElement); const timeSpan=document.createElement('span'); timeSpan.classList.add('timestamp'); if(senderType!=='bot'&&timestamp){timeSpan.textContent=new Date(timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});} else {timeSpan.textContent='';} wrapper.appendChild(timeSpan); messagesDiv.appendChild(wrapper); }
        function scrollToBottom() { requestAnimationFrame(() => { messagesDiv.scrollTop = messagesDiv.scrollHeight; }); }

        // --- Typing Indicator ---
        function handleUserTyping() { /* Same */ if(chatState!=='CHATTING'||!userTypingRef)return; set(userTypingRef,true); clearTimeout(typingTimeout); typingTimeout=setTimeout(()=>{set(userTypingRef,false);},2500); }

        // --- Admin Status Listener ---
        function listenToAdminStatus() {
             // *** Priority Fix: Verified Listener Logic ***
             if (adminStatusListener) off(adminStatusDbRef, 'value', adminStatusListener);
             console.log("[Admin Status] Setting listener on:", adminStatusDbRef.toString());
             adminStatusListener = onValue(adminStatusDbRef, (snapshot) => {
                const adminData = snapshot.val();
                const isOnline = adminData?.online === true; // Safely check online property
                console.log("[Admin Status] Data:", adminData, "| Online:", isOnline); // Debug Log
                adminStatusDot.classList.toggle('online', isOnline);
                adminStatusDot.classList.toggle('offline', !isOnline);
                adminStatusDot.title = isOnline ? 'Online' : 'Offline';
             }, (error) => {
                 console.error("[Admin Status] Listener error:", error);
                 adminStatusDot.classList.remove('online'); adminStatusDot.classList.add('offline'); adminStatusDot.title = 'Offline (Error)';
             });
        }

        // --- Audio Call & WebRTC ---
        // (WebRTC functions remain the same - handleCallButtonClick, startCallSequence, createPeerConnection, etc.)
        function handleCallButtonClick() { if(callButton.textContent==='Start Audio Call'){startCallSequence();}else{endCallSequence();} }
        async function startCallSequence() { if(chatState!=='CHATTING'||!callRef||!userName){displayMessage('bot',"Chat not active.");return;} console.log('Starting call...'); callButton.disabled=true; callStatusDiv.textContent='Requesting Mic...'; try { localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false}); console.log("Mic granted."); callStatusDiv.textContent='Connecting...'; } catch(e){ console.error("Mic error:",e); callStatusDiv.textContent='Mic denied!'; displayMessage('bot',"Mic needed."); callButton.disabled=false; return; } if(!createPeerConnection()){callStatusDiv.textContent='Setup failed.';endCallSequence();return;} localStream.getTracks().forEach(t=>peerConnection.addTrack(t,localStream)); console.log("Local track added."); try { makingOffer=true; await set(callRef,{state:'ringing',initiator:'user',timestamp:serverTimestamp(),userName:userName,offer:null,answer:null,userIceCandidates:null,adminIceCandidates:null}); console.log("State 'ringing'. Creating offer..."); const offer=await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); console.log("Offer created & set local."); await set(ref(db,`chats/${userId}/call/offer`),{type:offer.type,sdp:offer.sdp}); console.log("Offer sent."); updateCallUIBasedOnState('ringing'); } catch(e){ console.error("Offer error:",e); callStatusDiv.textContent='Setup failed.'; displayMessage('bot',"Call setup error."); endCallSequence(); } finally { makingOffer=false; } }
        function createPeerConnection() { console.log("Creating PC..."); try { peerConnection=new RTCPeerConnection(iceServers); peerConnection.onicecandidate=handleIceCandidate; peerConnection.ontrack=handleRemoteTrack; peerConnection.oniceconnectionstatechange=handleIceConnectionStateChange; peerConnection.onconnectionstatechange=handleConnectionStateChange; console.log("PC created."); return true; } catch(e){ console.error("PC creation failed:",e); return false; } }
        function handleIceCandidate(e) { if(e.candidate){console.log("ICE candidate..."); push(ref(db,`chats/${userId}/call/userIceCandidates`),e.candidate.toJSON()).catch(err=>console.error("Send ICE error:",err));} else {console.log("All ICE sent.");} }
        function handleRemoteTrack(e) { console.log("Remote track:",e.track.kind); if(e.streams&&e.streams[0]&&remoteAudio){console.log("Assigning remote stream."); remoteAudio.srcObject=e.streams[0]; remoteAudio.play().catch(err=>console.warn("Remote play failed:",err));} else {console.warn("No stream assign.");} }
        function handleIceConnectionStateChange() { if(!peerConnection)return; console.log("ICE State:",peerConnection.iceConnectionState); if(peerConnection.iceConnectionState==='failed'){console.error("ICE Failed."); displayMessage('bot',"Call conn failed (ICE)."); endCallSequence();} }
        function handleConnectionStateChange() { if(!peerConnection)return; console.log("Conn State:",peerConnection.connectionState); switch(peerConnection.connectionState){ case "connected":console.log("Peers connected!");break; case "disconnected":console.log("Peers disconnected.");break; case "failed":console.error("Conn failed."); displayMessage('bot',"Call conn failed."); endCallSequence(); break; case "closed":console.log("Conn closed."); endCallSequence(); break; } }
        function listenForCallChanges() { console.log("Setting call listeners..."); const stateRef=ref(db,`chats/${userId}/call/state`); const answerRef=ref(db,`chats/${userId}/call/answer`); const adminIceRef=ref(db,`chats/${userId}/call/adminIceCandidates`); const offerRef=ref(db,`chats/${userId}/call/offer`); if(callStateListener)off(stateRef,'value',callStateListener); if(callAnswerListener)off(answerRef,'value',callAnswerListener); if(callAdminIceCandidateListener)off(adminIceRef,'child_added',callAdminIceCandidateListener); if(callOfferListener)off(offerRef,'value',callOfferListener); callStateListener=onValue(stateRef,(s)=>{ const newState=s.val(); console.log("Call state:",newState); updateCallUIBasedOnState(newState); if(newState==='ended'||newState==='idle'||!newState){if(peerConnection&&peerConnection.connectionState!=="closed"){console.log("Remote end, cleaning."); closePeerConnection(); stopLocalStream();}} }); callAnswerListener=onValue(answerRef,async(s)=>{ const answer=s.val(); if(peerConnection&&peerConnection.signalingState==='have-local-offer'&&answer){console.log("Received answer."); try{await peerConnection.setRemoteDescription(new RTCSessionDescription(answer)); console.log("Remote answer set.");} catch(e){console.error("Set remote answer error:",e);}} }); callAdminIceCandidateListener=onChildAdded(adminIceRef,(s)=>{ if(s.exists()){const cand=s.val(); console.log("Received admin ICE."); if(peerConnection&&peerConnection.remoteDescription){peerConnection.addIceCandidate(new RTCIceCandidate(cand)).then(()=>console.log("Admin ICE added.")).catch(e=>console.error("Add admin ICE error:",e));} else {console.warn("Admin ICE but PC not ready.");} remove(s.ref);} }); callOfferListener=onValue(offerRef,async(s)=>{ const offer=s.val(); const callState=await get(ref(db,`chats/${userId}/call/state`)).then(sn=>sn.val()); if(!makingOffer&&offer&&callState==='ringing'&&peerConnection?.signalingState==='stable'){console.log("Received offer (Admin init?)."); displayMessage('bot',"Incoming call!"); updateCallUIBasedOnState('ringing'); console.warn("Answering admin calls not fully implemented.");} }); }
        function closePeerConnection() { if(peerConnection){console.log("Closing PC."); peerConnection.onicecandidate=null; peerConnection.ontrack=null; peerConnection.oniceconnectionstatechange=null; peerConnection.onconnectionstatechange=null; peerConnection.close(); peerConnection=null;} }
        function stopLocalStream() { if(localStream){console.log("Stopping local stream."); localStream.getTracks().forEach(t=>t.stop()); localStream=null;} if(remoteAudio)remoteAudio.srcObject=null; }
        async function endCallSequence() { console.log("Ending call sequence..."); stopLocalStream(); closePeerConnection(); try { const stateSnap=await get(ref(db,`chats/${userId}/call/state`)); if(stateSnap.exists()&&stateSnap.val()!=='ended'&&stateSnap.val()!=='idle'){await update(callRef,{state:'ended',endedBy:'user',endTimestamp:serverTimestamp()}); console.log("Call state 'ended'."); remove(ref(db,`chats/${userId}/call/offer`)); remove(ref(db,`chats/${userId}/call/answer`)); remove(ref(db,`chats/${userId}/call/userIceCandidates`)); remove(ref(db,`chats/${userId}/call/adminIceCandidates`));} else {console.log("Call already ended/idle.");} } catch(e){console.error("Error ending call in FB:",e);} updateCallUIBasedOnState('ended'); console.log("Call seq ended."); }
        function updateCallUIBasedOnState(state) { if(chatState!=='CHATTING'){callStatusDiv.textContent='';callButton.textContent='Start Audio Call';callButton.disabled=true;return;} switch(state){ case 'ringing':get(ref(db,`chats/${userId}/call/initiator`)).then(s=>{if(s.val()==='user'){callStatusDiv.textContent='Calling...';callButton.textContent='Cancel Call';callButton.disabled=false;}else{callStatusDiv.textContent='Incoming...';callButton.textContent='Answer';callButton.disabled=false;}}); break; case 'active':callStatusDiv.textContent='In call';callButton.textContent='End Call';callButton.disabled=false; break; case 'ended':case 'idle':default: get(ref(db,`chats/${userId}/call/endedBy`)).then(s=>{const endedBy=s.val();callStatusDiv.textContent=state==='ended'?`Call ended${endedBy?' by '+endedBy:''}.`:'';}); callButton.textContent='Start Audio Call';callButton.disabled=false; break; } }


        // --- Notifications ---
        function requestNotificationPermission() { /* Same */ if(!('Notification'in window))return; if(Notification.permission!=='granted'&&Notification.permission!=='denied')Notification.requestPermission().then(p=>console.log(`Notify permission:${p}`)); }
        function showNotification(message) { /* Same */ if(!('Notification'in window)||Notification.permission!=='granted')return; if(document.hidden){const n=new Notification('Chat Support',{body:message});setTimeout(n.close.bind(n),5000);} }

        // --- Run Application ---
        initApp();

    </script>
</body>
</html>